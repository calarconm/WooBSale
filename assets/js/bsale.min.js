var info_state = null;
var states = ["stock","price_list","price_list_details","product_types","products",'sync','complete'];
//var states = ['sync','complete'];
var statesString = ["Actualizacion de Inventario","Cargando Lista de Precios","Actualizando Lista de Precios","Actualizando categorias de productos","Actualizando productos",'Creando y Actualizando productos','Sincronizacion Completa'];
//var statesString = ['Creando y Actualizando productos','Sincronizacion Completa'];
var state = null;
var page = 0;
var transition = false;
(function($){
	$(document).on("click",'.bsale-check-type',function(){
		$.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			dataType: "json",
			data: {
				action : 'bsale_selector',
				selection:$(this).val()
			},
			beforeSend: function(){

			},
			success: function(result){
				console.log(result)
				window.location.reload();
			}
		});
	})

	$(document).on('click','.bsale-save-button',function(e){
	 	e.preventDefault();
		var resource = $(this).attr("resource");
		var trigger = $(this).attr("trigger")
		console.log();
		$.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			dataType: "json",
			data: {
				action : 'bsale_request',
				resource: resource,
				trigger: trigger
			},
			beforeSend: function(){

			},
			success: function(result){
				console.log(result)
			}
		});
	});

	$(document).on('click','#bsale-sync-products',function(e){
		info_state = null;
		state = 0;
		page = 0;
		key = states[state];
		$.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			dataType:"json",
			data: {
				action : 'bsale_sync',
				info:true,
				context : key
			},
			beforeSend: function(){
				$("#bsale-sync-loader").addClass("is-active")
				$("#bsale-sync-loader").html(statesString[state])
			},
			success: function(results){
				info_state = results;
				console.log([key,results])
				sync();
			}
		});
		e.preventDefault();
	});
})(jQuery);

function sync(){
	if(transition){
		jQuery.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			dataType:"json",
			data: {
				action : 'bsale_sync',
				info:true,
				context : key,
			},
			beforeSend: function(){

			},
			success: function(results){
				transition=false;
				console.log([key,results])
				info_state = results;
				jQuery("#bsale-sync-loader").html(statesString[state])
				if(key!='complete'){
					setTimeout(function(){
						sync();
					},2000)
				}
				else{
					jQuery("#bsale-sync-loader").removeClass("is-active")
					jQuery("#bsale-sync-loader").html("")
					//alert(results.status)
				}
			}
		});
	}
	else{
		jQuery.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			dataType:"json",
			data: {
				action : 'bsale_sync',
				info:false,
				context : key,
				page:page
			},
			beforeSend: function(){

			},
			success: function(results){
				console.log([page,info_state])
				html = statesString[state];
				html+= " Pagina: "+(page)+"/"+(info_state.pages);
				jQuery("#bsale-sync-loader").html(html)
				if(page>=info_state.pages){
					info_state=null;
					transition = true;
					state = state + 1;
					key = states[state];
					page = 0
				}
				else{
					page = page + 1;
				}
				setTimeout(function(){
					sync();
				},2000)
			}
		});
	}

	/*if(state < states.length){
		console.log(count)
		console.log(states[state])
		key = states[state];
		console.log(info_states)
		page = page + 1;
		$.ajax({
			url : bsale_vars.ajaxurl,
			type: 'post',
			data: {
				action : 'bsale_sync',
				context : key,
				page:page
			},
			beforeSend: function(){

			},
			success: function(results){
				console.log(results)
				info_states = {"stock":results.stock,"price_lists":results.price_lists,"product_types":results.product_types,"products":results.products};
				sync();
			}
		});
		if(count>info_states[key]){
			count = 0;
			state = state + 1;
		}
		setTimeout(function(){
			sync()
		},1000);
	}
	else{
		info_states = {"stock":null,"price_lists":null,"product_types":null,"products":null};
		state = 0;
		count = 0;
		//window.location.reload();
	}*/
}

function get_stock(){

}

function get_price_list(){

}

function get_products(){
	jQuery.ajax({
        type:"GET",
        url: "./JvmInfoClass",
        success: function(data){
            console.warn("get jvm info success");
            setTimeout(recursively_ajax, 3000)
        }
  });
}
